<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì  ê³„ì‚°ê¸° í”„ë¡œí† íƒ€ì…</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background-color: #ffffff;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #1a1a1a;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (3ë‹¨ ë ˆì´ì•„ì›ƒ) */
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* ê° íŒ¨ë„ì˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .panel {
            padding: 20px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 20px; /* ìš”ì†Œ ê°„ ê°„ê²© */
        }
        .panel:last-child {
            border-right: none;
        }

        /* íŒ¨ë„ ë„ˆë¹„ ì„¤ì • */
        #left-panel { flex: 1.2; }
        #center-panel { flex: 0.8; background-color: #f8f9fa; }
        #right-panel { flex: 1.5; }

        /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
        h2 {
            font-size: 1em;
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        
        /* ì‹œê°í™” ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
        .visualizer-window {
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #ffffff;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 0.9em;
            overflow: hidden;
            position: relative;
        }

        /* ì‹œê°í™” ìœˆë„ìš° ë‚´ë¶€ì˜ ì´ë¯¸ì§€/SVGê°€ ê½‰ ì°¨ë„ë¡ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .visualizer-window svg, .visualizer-window img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
        }
        
        #file-name {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        /* ë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #layer-list-container {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fff;
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .layer-item {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .layer-item input {
            margin-right: 8px;
        }
        
        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ìƒë‹¨ UI (í†µê³„, ì²´í¬ë°•ìŠ¤) */
        #right-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        #area-stats {
            background-color: #e9f5ff;
            border: 1px solid #b3d7ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        #view-options {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ê³„ì‚° ê²°ê³¼ */
        #calculation-result {
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <header>
        ğŸšŒ ë²„ìŠ¤ ê´‘ê³  ë©´ì  ê³„ì‚°ê¸°
    </header>

    <div class="main-container">
        <div id="left-panel" class="panel">
            <h2>AI íŒŒì¼</h2>
            <div>
                <button id="upload-btn" class="btn">ì¼ëŸ¬ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="file-input" accept=".ai" hidden>
                <p id="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>
            </div>
            <div id="ai-visualizer" class="visualizer-window">
                <span>AI íŒŒì¼ ì‹œê°í™” ì˜ì—­</span>
            </div>
        </div>

        <div id="center-panel" class="panel">
            <h2>ë ˆì´ì–´ ëª©ë¡</h2>
            <div id="layer-list-container">
                <div id="special-layers">
                    </div>
                <hr id="layer-separator" style="display: none;">
                <div id="dynamic-layers">
                    <p>AI íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div id="right-panel" class="panel">
            <h2 id="right-panel-title">ì •ë³´</h2>
            <div id="right-panel-header">
                <div id="area-stats">
                    <p><strong>ê´‘ê³  ë©´ì  ë¹„ìœ¨:</strong> <span id="ratio-value">-</span>%</p>
                    <p>ë²„ìŠ¤ì˜ ê´‘ê³  ê°€ëŠ¥ ë©´ì : <span id="ad-possible-area-value">-</span> pxÂ²</p>
                    <p>ê´‘ê³  ë©´ì : <span id="ad-area-value">-</span> pxÂ²</p>
                </div>
                <div id="view-options">
                    <label><input type="checkbox" id="mask-check"> ë§ˆìŠ¤í¬</label>
                </div>
            </div>
            <div id="layer-visualizer" class="visualizer-window">
                <span id="layer-visualizer-text">ì„ íƒëœ ë ˆì´ì–´ ì‹œê°í™” ì˜ì—­</span>
            </div>
            <div id="calculation-result">
                <strong>í˜„ì¬ ì„ íƒí•œ ë ˆì´ì–´ì˜ ë©´ì  ë¹„ìœ¨:</strong> <span id="selected-layer-ratio">-</span>%
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const aiVisualizerDiv = document.getElementById('ai-visualizer');

            const layerListContainer = document.getElementById('layer-list-container');
            const specialLayersDiv = document.getElementById('special-layers');
            const dynamicLayersDiv = document.getElementById('dynamic-layers');
            const layerSeparator = document.getElementById('layer-separator');

            const rightPanelTitle = document.getElementById('right-panel-title');
            const layerVisualizerDiv = document.getElementById('layer-visualizer');
            const ratioValue = document.getElementById('ratio-value');
            const adPossibleAreaValueSpan = document.getElementById('ad-possible-area-value');
            const adAreaValueSpan = document.getElementById('ad-area-value');
            const selectedLayerRatioSpan = document.getElementById('selected-layer-ratio');

            const maskCheck = document.getElementById('mask-check');

            let specialVisualsData = {}; // íŠ¹ë³„ ì‹œê°í™” ë°ì´í„° ì €ì¥
            let dynamicLayersData = []; // ë™ì  ë ˆì´ì–´ ë°ì´í„° ì €ì¥ìš© ë°°ì—´

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.name.endsWith('.ai')) {
                        requestCalculation(file);
                    } else {
                        alert('.ai íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                }
            });

            layerListContainer.addEventListener('change', (event) => {
                if (event.target.name === 'layer') {
                    const selectedRadio = event.target;
                    const viewType = selectedRadio.value;

                    if (viewType.startsWith('special-')) {
                        const key = viewType.replace('special-', '');
                        const visualData = specialVisualsData?.[key];
                        if(visualData) {
                            const name = selectedRadio.dataset.name;
                            updateRightPanel(name, visualData.area, visualData.image, 'png');
                        }
                    } else {
                        const value = selectedRadio.value; // e.g., "dynamic-2"
                        const index = parseInt(value.split('-')[1]); // e.g., 2

                        if (!isNaN(index) && dynamicLayersData?.[index]) {
                            const layerData = dynamicLayersData?.[index];
                            updateRightPanel(layerData.name, layerData.area, layerData.image, 'png');
                        }
                    }
                }
            });

            maskCheck.addEventListener('change', () => {
                // í˜„ì¬ ì„ íƒëœ ë ˆì´ì–´ ì •ë³´ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ updateRightPanel í˜¸ì¶œ
                const selectedRadio = layerListContainer.querySelector('input:checked');
                if (selectedRadio) {
                    const viewType = selectedRadio.value;
                    if (viewType.startsWith('special-')) {
                        const key = viewType.replace('special-', '');
                        const visualData = specialVisualsData?.[key];
                        if (visualData) {
                            updateRightPanel(selectedRadio.dataset.name, visualData.area, visualData.image, 'png');
                        }
                    } else {
                        const index = parseInt(viewType.split('-')[1]);
                        if (!isNaN(index) && dynamicLayersData?.[index]) {
                            const layerData = dynamicLayersData?.[index];
                            updateRightPanel(layerData.name, layerData.area, layerData.image, 'png');
                        }
                    }
                }
            });

            // --- í•¨ìˆ˜ ì •ì˜ ---

            async function requestCalculation(file) {
                const formData = new FormData();
                formData.append('aiFile', file);

                fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name} (ì²˜ë¦¬ ì¤‘...)`;
                uploadBtn.disabled = true;
                aiVisualizerDiv.innerHTML = '<span>AI íŒŒì¼ ë³€í™˜ ì¤‘...</span>';
                dynamicLayersDiv.innerHTML = '<p>ë ˆì´ì–´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
                specialLayersDiv.innerHTML = '';
                layerSeparator.style.display = 'none';

                try {
                    const response = await fetch('http://127.0.0.1:5000/api/calculate', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

                    // ì™¼ìª½ íŒ¨ë„ ì‹œê°í™”
                    if (data.visualization) {
                        aiVisualizerDiv.innerHTML = data.visualization;
                        const svgElement = aiVisualizerDiv.querySelector('svg');
                        if (svgElement) {
                            svgElement.style.width = '100%';
                            svgElement.style.height = '100%';
                        }
                    }

                    // íŠ¹ë³„ ì‹œê°í™” ë°ì´í„° ì €ì¥ ë° ì •ì  UI ìƒì„±
                    if (data.special_visuals) {
                        specialVisualsData = data.special_visuals;
                        populateSpecialLayers();

                        const adPossibleArea = specialVisualsData?.ad_possible?.area;
                        const adArea = specialVisualsData?.ad_area?.area;

                        // ê³ ì •ëœ ê´‘ê³  ë©´ì  ë¹„ìœ¨ ê³„ì‚° ë° í‘œì‹œ
                        let fixedRatioString = '-';
                        if (adPossibleArea && adPossibleArea > 0 && adArea) {
                            const fixedRatio = (parseInt(adArea) / adPossibleArea) * 100;
                            fixedRatioString = fixedRatio.toFixed(1);
                        }
                        ratioValue.textContent = fixedRatioString;

                        // ê´‘ê³  ê°€ëŠ¥ ë©´ì ê³¼ ê´‘ê³  ë©´ì  ê°’ í‘œì‹œ
                        adPossibleAreaValueSpan.textContent = adPossibleArea ? parseInt(adPossibleArea).toLocaleString() : '-';
                        adAreaValueSpan.textContent = adArea ? parseInt(adArea).toLocaleString() : '-';
                    }

                    // ë™ì  ë ˆì´ì–´ ëª©ë¡ ìƒì„±
                    if (Array.isArray(data.layers)) {
                        dynamicLayersData = data.layers;
                        populateDynamicLayers(data.layers);
                    }

                    // ì²« ë²ˆì§¸ ì •ì  ë ˆì´ì–´ë¥¼ ê¸°ë³¸ ì„ íƒ
                    const firstRadio = specialLayersDiv.querySelector('input[type="radio"]');
                    if (firstRadio) {
                        firstRadio.checked = true;
                        firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                } catch (error) {
                    console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                    aiVisualizerDiv.innerHTML = `<span>ì˜¤ë¥˜: ${error.message}</span>`;
                    dynamicLayersDiv.innerHTML = '';
                    specialLayersDiv.innerHTML = '';
                } finally {
                    fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
                    uploadBtn.disabled = false;
                }
            }

            function createRadioElement(id, name, text, area) {
                const label = document.createElement('label');
                label.className = 'layer-item';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'layer';
                radio.value = id;
                radio.dataset.name = text;
                radio.dataset.area = area;

                label.appendChild(radio);
                let labelText = text;
                if (area !== undefined && area > 0) {
                    labelText += ` (${area.toLocaleString()} px)`;
                }
                label.appendChild(document.createTextNode(labelText));
                return label;
            }

            function populateSpecialLayers() {
                specialLayersDiv.innerHTML = '';
                specialLayersDiv.appendChild(createRadioElement('special-all_view', 'ì „ì²´ë³´ê¸°', 'ì „ì²´ë³´ê¸°', specialVisualsData.all_view.area));
                specialLayersDiv.appendChild(createRadioElement('special-ad_possible', 'ë²„ìŠ¤ì˜ ê´‘ê³  ê°€ëŠ¥ ë©´ì ', 'ë²„ìŠ¤ì˜ ê´‘ê³  ê°€ëŠ¥ ë©´ì ', specialVisualsData.ad_possible.area));
                specialLayersDiv.appendChild(createRadioElement('special-ad_area', 'ê´‘ê³  ë©´ì ', 'ê´‘ê³  ë©´ì ', specialVisualsData.ad_area.area));
            }

            function populateDynamicLayers(layers) {
                dynamicLayersDiv.innerHTML = '';
                if (layers && layers.length > 0) {
                    layerSeparator.style.display = 'block';
                }
                layers.forEach((layer, index) => {
                    const radioElement = createRadioElement(
                        `dynamic-${index}`,
                        layer.name,
                        layer.name,
                        layer.area
                    );
                    dynamicLayersDiv.appendChild(radioElement);
                });
            }

            function updateRightPanel(layerName, pixelArea, visualData, type) {
                if (!layerName) return;

                rightPanelTitle.textContent = layerName;

                if (visualData && type === 'png') {
                    const base64Src = `data:image/png;base64,${visualData}`;
                    if (maskCheck.checked) {
                        applyMask(base64Src, (maskedImageSrc) => {
                            layerVisualizerDiv.innerHTML = `<img src="${maskedImageSrc}" alt="${layerName} ë§ˆìŠ¤í¬ ì‹œê°í™”" />`;
                        });
                    } else {
                        layerVisualizerDiv.innerHTML = `<img src="${base64Src}" alt="${layerName} ì‹œê°í™”" />`;
                    }
                } else {
                    layerVisualizerDiv.innerHTML = '<span>ì‹œê°í™” ë°ì´í„° ì—†ìŒ</span>';
                }

                const adPossibleArea = specialVisualsData?.ad_possible?.area;
                let dynamicRatioString = '-';

                if (adPossibleArea && adPossibleArea > 0 && pixelArea) {
                    const dynamicRatio = (parseInt(pixelArea) / adPossibleArea) * 100;
                    dynamicRatioString = dynamicRatio.toFixed(1);
                }
                selectedLayerRatioSpan.textContent = dynamicRatioString;
            }
            
            function applyMask(base64Image, callback) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i + 3] > 0) {
                            data[i] = 0;
                            data[i + 1] = 0;
                            data[i + 2] = 0;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                    
                    callback(canvas.toDataURL('image/png'));
                };
                img.src = base64Image;
            }
        });
    </script>
</body>
</html>