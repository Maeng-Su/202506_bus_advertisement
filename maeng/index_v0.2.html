<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì  ê³„ì‚°ê¸° í”„ë¡œí† íƒ€ì… v2.3</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background-color: #ffffff;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #1a1a1a;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (3ë‹¨ ë ˆì´ì•„ì›ƒ) */
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* ê° íŒ¨ë„ì˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .panel {
            padding: 20px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 20px; /* ìš”ì†Œ ê°„ ê°„ê²© */
        }
        .panel:last-child {
            border-right: none;
        }

        /* íŒ¨ë„ ë„ˆë¹„ ì„¤ì • */
        #left-panel { flex: 1.2; }
        #center-panel { flex: 0.8; background-color: #f8f9fa; }
        #right-panel { flex: 1.5; }

        /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
        h2 {
            font-size: 1em;
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        
        /* ì‹œê°í™” ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
        .visualizer-window {
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #ffffff;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 0.9em;
            overflow: hidden;
            position: relative;
        }

        .visualizer-window img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #a0cfff; cursor: not-allowed; }
        
        #file-name {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        
        /* ë ˆì´ì–´ ì„ íƒ UI ìŠ¤íƒ€ì¼ */
        .layer-select, .layer-list-container {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fff;
            padding: 10px;
        }
        .layer-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .layer-select {
            width: 100%;
            font-size: 0.9em;
        }

        .layer-item {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .layer-item input { margin-right: 8px; }
        
        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ìƒë‹¨ UI */
        #right-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        #area-stats {
            background-color: #e9f5ff;
            border: 1px solid #b3d7ff;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            flex-grow: 1;
        }
        #area-stats p { margin: 5px 0; }

        #view-options {
            display: flex;
            flex-direction: column; /* ì²´í¬ë°•ìŠ¤ë¥¼ ì„¸ë¡œë¡œ ë°°ì—´ */
            gap: 10px; /* ì²´í¬ë°•ìŠ¤ ê°„ ê°„ê²© */
            font-size: 0.9em;
            padding-left: 20px;
        }
    </style>
</head>
<body>

    <header>ğŸšŒ ë²„ìŠ¤ ê´‘ê³  ë©´ì  ê³„ì‚°ê¸° v2.3</header>

    <div class="main-container">
        <div id="left-panel" class="panel">
            <h2>AI íŒŒì¼</h2>
            <div>
                <button id="upload-btn" class="btn">ì¼ëŸ¬ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="file-input" accept=".ai" hidden>
                <p id="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>
            </div>
            <div id="ai-visualizer" class="visualizer-window">
                <span>AI íŒŒì¼ ì‹œê°í™” ì˜ì—­</span>
            </div>
        </div>

        <div id="center-panel" class="panel">
            <h2>ë²„ìŠ¤ ê´‘ê³ ê°€ëŠ¥ ì˜ì—­ ì„ íƒ</h2>
            <select id="denominator-layer-select" class="layer-select" disabled>
                <option>AI íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.</option>
            </select>
            
            <h2 style="margin-top: 15px;">ê´‘ê³  ë ˆì´ì–´ ì„ íƒ</h2>
            <div id="numerator-layers-container" class="layer-list-container">
                <p>AI íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
            </div>
        </div>

        <div id="right-panel" class="panel">
            <h2 id="right-panel-title">ì •ë³´</h2>
            <div id="right-panel-header">
                <div id="area-stats">
                    <p><strong>ê´‘ê³  ê°€ëŠ¥ ì˜ì—­ ë©´ì :</strong><br><span id="denominator-area-value">-</span> pxÂ²</p>
                    <p><strong>ì„ íƒ ê´‘ê³  ë©´ì  í•©ê³„:</strong><br><span id="numerator-area-value">-</span> pxÂ²</p>
                    <hr>
                    <p><strong><span style="color: #0056b3; font-size: 1.1em;">ê´‘ê³  ë©´ì  ë¹„ìœ¨:</span></strong><br><span id="final-ratio-value" style="color: #0056b3; font-size: 1.2em; font-weight: bold;">-</span> %</p>
                </div>
                <div id="view-options">
                    <label><input type="checkbox" id="mask-check"> ë§ˆìŠ¤í¬</label>
                    <label><input type="checkbox" id="show-bus-area-check"> ë²„ìŠ¤ì˜ì—­ í‘œì‹œ</label>
                </div>
            </div>
            <div id="layer-visualizer" class="visualizer-window">
                <span>ì„ íƒëœ ë ˆì´ì–´ ì‹œê°í™” ì˜ì—­</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ì „ì—­ ë³€ìˆ˜ ë° ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            let allLayersData = [];
            
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const aiVisualizerDiv = document.getElementById('ai-visualizer');

            const denominatorSelect = document.getElementById('denominator-layer-select');
            const numeratorContainer = document.getElementById('numerator-layers-container');

            const rightPanelTitle = document.getElementById('right-panel-title');
            const layerVisualizerDiv = document.getElementById('layer-visualizer');
            const denominatorAreaValueSpan = document.getElementById('denominator-area-value');
            const numeratorAreaValueSpan = document.getElementById('numerator-area-value');
            const finalRatioValueSpan = document.getElementById('final-ratio-value');
            
            const maskCheck = document.getElementById('mask-check');
            const showBusAreaCheck = document.getElementById('show-bus-area-check');

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.name.endsWith('.ai')) { requestCalculation(file); } 
                    else { alert('.ai íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); }
                }
            });

            denominatorSelect.addEventListener('change', updateCalculationAndVisualization);
            numeratorContainer.addEventListener('change', updateCalculationAndVisualization);
            maskCheck.addEventListener('change', updateCalculationAndVisualization);
            showBusAreaCheck.addEventListener('change', updateCalculationAndVisualization);

            // --- í•¨ìˆ˜ ì •ì˜ ---
            
            /** ì´ë¯¸ì§€ ë¡œë”©ì„ ìœ„í•œ Promise í—¬í¼ í•¨ìˆ˜ */
            function loadImage(layer) {
                return new Promise((resolve, reject) => {
                    if (!layer || !layer.image) return reject(new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ë ˆì´ì–´ ë°ì´í„°"));
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error(`ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨: ${layer.name}`));
                    img.src = `data:image/png;base64,${layer.image}`;
                });
            }

            /** AI íŒŒì¼ ì²˜ë¦¬ ìš”ì²­ */
            async function requestCalculation(file) {
                const formData = new FormData();
                formData.append('aiFile', file);
                resetUIForLoading(file.name);

                try {
                    const response = await fetch('http://127.0.0.1:5000/api/calculate', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

                    if (data.visualization) {
                        const img = new Image();
                        img.onload = () => {
                            aiVisualizerDiv.innerHTML = '';
                            aiVisualizerDiv.appendChild(img);
                             // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ì²« ê³„ì‚°ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                            updateCalculationAndVisualization();
                        }
                        img.src = `data:image/png;base64,${data.visualization}`;
                        img.alt="AI File Visualization";

                    }
                    if (Array.isArray(data.layers)) {
                        allLayersData = data.layers;
                        populateLayerSelectors();
                    } else {
                         throw new Error("ì„œë²„ì—ì„œ ìœ íš¨í•œ ë ˆì´ì–´ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                    aiVisualizerDiv.innerHTML = `<span>ì˜¤ë¥˜: ${error.message}</span>`;
                    numeratorContainer.innerHTML = `<p>ì˜¤ë¥˜: ${error.message}</p>`;
                } finally {
                    fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
                    uploadBtn.disabled = false;
                    denominatorSelect.disabled = (allLayersData.length === 0);
                }
            }
            
            function resetUIForLoading(fileName) {
                fileNameDisplay.textContent = `ì„ íƒëœ íŒŒì¼: ${fileName} (ì²˜ë¦¬ ì¤‘...)`;
                uploadBtn.disabled = true;
                aiVisualizerDiv.innerHTML = '<span>AI íŒŒì¼ ë³€í™˜ ì¤‘...</span>';
                numeratorContainer.innerHTML = '<p>ë ˆì´ì–´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>';
                denominatorSelect.innerHTML = '<option>ë ˆì´ì–´ ë¶„ì„ ì¤‘...</option>';
                denominatorSelect.disabled = true;
                allLayersData = [];
                resetRightPanel();
            }

            function resetRightPanel() {
                rightPanelTitle.textContent = "ì •ë³´";
                denominatorAreaValueSpan.textContent = '-';
                numeratorAreaValueSpan.textContent = '-';
                finalRatioValueSpan.textContent = '-';
                layerVisualizerDiv.innerHTML = '<span>ì„ íƒëœ ë ˆì´ì–´ ì‹œê°í™” ì˜ì—­</span>';
            }

            function populateLayerSelectors() {
                denominatorSelect.innerHTML = '';
                numeratorContainer.innerHTML = '';
                if (allLayersData.length === 0) {
                    denominatorSelect.innerHTML = '<option>ë ˆì´ì–´ ì—†ìŒ</option>';
                    numeratorContainer.innerHTML = '<p>í‘œì‹œí•  ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                allLayersData.forEach((layer, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${layer.name} (${layer.area.toLocaleString()} pxÂ²)`;
                    denominatorSelect.appendChild(option);

                    const label = document.createElement('label');
                    label.className = 'layer-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = index;
                    label.appendChild(checkbox);
                    const textNode = document.createTextNode(` ${layer.name} (${layer.area.toLocaleString()} pxÂ²)`);
                    label.appendChild(textNode);
                    numeratorContainer.appendChild(label);
                });
            }

            /** ê³„ì‚° ë° ì‹œê°í™” ì—…ë°ì´íŠ¸ (í•µì‹¬ ë¡œì§) */
            function updateCalculationAndVisualization() {
                if (allLayersData.length === 0) return resetRightPanel();
                
                const mainImg = aiVisualizerDiv.querySelector('img');
                 if (!mainImg || !mainImg.complete || mainImg.naturalWidth === 0) {
                    // ì•„ì§ ë©”ì¸ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê³„ì‚°ì„ ë¯¸ë£¹ë‹ˆë‹¤.
                    return;
                }

                const denominatorIndex = parseInt(denominatorSelect.value);
                const selectedNumeratorCheckboxes = numeratorContainer.querySelectorAll('input:checked');
                const denominatorLayer = allLayersData[denominatorIndex];
                
                const numeratorLayers = [];
                selectedNumeratorCheckboxes.forEach(cb => {
                    const index = parseInt(cb.value);
                    if (allLayersData[index]) numeratorLayers.push(allLayersData[index]);
                });
                
                const denominatorArea = denominatorLayer.area;
                denominatorAreaValueSpan.textContent = denominatorArea.toLocaleString();
                rightPanelTitle.textContent = `ê´‘ê³  ë ˆì´ì–´ (${numeratorLayers.length}ê°œ ì„ íƒ)`;
                
                const backgroundLayer = showBusAreaCheck.checked ? denominatorLayer : null;
                
                // â˜…â˜…â˜… ë³€ê²½ëœ ë¶€ë¶„ â˜…â˜…â˜…
                // ì‹œê°í™” í•¨ìˆ˜ê°€ ì´ì œ ê³„ì‚°ëœ ë©´ì ì„ ì½œë°±ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
                displayCompositeImage(numeratorLayers, backgroundLayer, (calculatedNumeratorArea) => {
                    // ì½œë°± í•¨ìˆ˜ ë‚´ì—ì„œ ë©´ì ê³¼ ë¹„ìœ¨ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    const ratio = denominatorArea > 0 ? (calculatedNumeratorArea / denominatorArea) * 100 : 0;
                    numeratorAreaValueSpan.textContent = calculatedNumeratorArea.toLocaleString();
                    finalRatioValueSpan.textContent = ratio.toFixed(1);
                });
            }

            /** ì—¬ëŸ¬ ë ˆì´ì–´ ì´ë¯¸ì§€ë¥¼ í•©ì¹˜ê³ , ë©´ì  ê³„ì‚° í›„, ì‹œê°í™” (ë¡œì§ ìˆ˜ì •ë¨) */
            function displayCompositeImage(adLayers, backgroundLayer, onAreaCalculated) {
                const mainImg = aiVisualizerDiv.querySelector('img');
                if (!mainImg) return; // ê¸°ë³¸ ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

                const canvasWidth = mainImg.naturalWidth;
                const canvasHeight = mainImg.naturalHeight;

                if (adLayers.length === 0 && !backgroundLayer) {
                    layerVisualizerDiv.innerHTML = '<span>í‘œì‹œí•  ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    if(onAreaCalculated) onAreaCalculated(0);
                    return;
                }

                const adLayerPromises = adLayers.map(layer => loadImage(layer));
                
                // 1. ê´‘ê³  ë ˆì´ì–´ë“¤ë§Œ ë¨¼ì € ì²˜ë¦¬í•˜ì—¬ ë©´ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
                Promise.all(adLayerPromises)
                    .then(ad_imgs => {
                        const areaCanvas = document.createElement('canvas');
                        areaCanvas.width = canvasWidth;
                        areaCanvas.height = canvasHeight;
                        const areaCtx = areaCanvas.getContext('2d');
                        
                        ad_imgs.forEach(img => areaCtx.drawImage(img, 0, 0));

                        // ê²¹ì¹¨ì´ ê³ ë ¤ëœ ì‹¤ì œ ë©´ì  ê³„ì‚°
                        const imageData = areaCtx.getImageData(0, 0, canvasWidth, canvasHeight).data;
                        let unionArea = 0;
                        for (let i = 3; i < imageData.length; i += 4) { // Alpha ì±„ë„ë§Œ í™•ì¸
                            if (imageData[i] > 0) unionArea++;
                        }
                        
                        // ê³„ì‚°ëœ ë©´ì ì„ ì½œë°±ìœ¼ë¡œ ì „ë‹¬
                        if (onAreaCalculated) onAreaCalculated(unionArea);
                        
                        // 2. ì´ì œ í™”ë©´ì— í‘œì‹œë  ì‹œê°í™” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                        const backgroundPromise = backgroundLayer ? loadImage(backgroundLayer) : Promise.resolve(null);
                        backgroundPromise.then(background_img => {
                            const finalCanvas = document.createElement('canvas');
                            finalCanvas.width = canvasWidth;
                            finalCanvas.height = canvasHeight;
                            const finalCtx = finalCanvas.getContext('2d');
                            
                            if (background_img) finalCtx.drawImage(background_img, 0, 0);
                            
                            // ë§ˆìŠ¤í¬ ì˜µì…˜ì´ ì¼œì ¸ìˆìœ¼ë©´, ë©´ì  ê³„ì‚°ì— ì‚¬ìš©ëœ ìº”ë²„ìŠ¤ì— ë§ˆìŠ¤í¬ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
                            if (maskCheck.checked && ad_imgs.length > 0) {
                                const maskedData = areaCtx.getImageData(0, 0, canvasWidth, canvasHeight);
                                const data = maskedData.data;
                                for (let i = 0; i < data.length; i += 4) {
                                    if (data[i + 3] > 0) { data[i] = 0; data[i + 1] = 0; data[i + 2] = 0; }
                                }
                                areaCtx.putImageData(maskedData, 0, 0);
                            }
                            
                            // ë°°ê²½ ìœ„ì— (ë§ˆìŠ¤í¬ ì ìš©ëœ) ê´‘ê³  ë ˆì´ì–´ ì´ë¯¸ì§€ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
                            finalCtx.drawImage(areaCanvas, 0, 0);
                            layerVisualizerDiv.innerHTML = `<img src="${finalCanvas.toDataURL()}" alt="Composite visualization" />`;
                        });
                    })
                    .catch(err => {
                        console.error("ë³µí•© ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:", err);
                        layerVisualizerDiv.innerHTML = `<span>ì´ë¯¸ì§€ ë Œë”ë§ ì˜¤ë¥˜</span>`;
                        if (onAreaCalculated) onAreaCalculated(0);
                    });
            }
        });
    </script>
</body>
</html>