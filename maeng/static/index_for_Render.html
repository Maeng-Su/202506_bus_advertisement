<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>면적 계산기 프로토타입</title>
    <style>
        /* 기본 스타일 및 폰트 설정 */
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 헤더 스타일 */
        header {
            background-color: #ffffff;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #1a1a1a;
        }

        /* 메인 컨테이너 (3단 레이아웃) */
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* 각 패널의 공통 스타일 */
        .panel {
            padding: 20px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 20px; /* 요소 간 간격 */
        }
        .panel:last-child {
            border-right: none;
        }

        /* 패널 너비 설정 */
        #left-panel { flex: 1.2; }
        #center-panel { flex: 0.8; background-color: #f8f9fa; }
        #right-panel { flex: 1.5; }

        /* 섹션 제목 스타일 */
        h2 {
            font-size: 1em;
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        
        /* 시각화 윈도우 스타일 */
        .visualizer-window {
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #ffffff;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 0.9em;
            overflow: hidden;
            position: relative;
        }

        /* 시각화 윈도우 내부의 이미지/SVG가 꽉 차도록 스타일 추가 */
        .visualizer-window svg, .visualizer-window img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* 버튼 스타일 */
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
        }
        
        #file-name {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        /* 레이어 리스트 스타일 */
        #layer-list-container {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fff;
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .layer-item {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .layer-item input {
            margin-right: 8px;
        }
        
        /* 오른쪽 패널 상단 UI (통계, 체크박스) */
        #right-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        #area-stats {
            background-color: #e9f5ff;
            border: 1px solid #b3d7ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        #view-options {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        /* 오른쪽 패널 계산 결과 */
        #calculation-result {
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <header>
        🚌 버스 광고 면적 계산기
    </header>

    <div class="main-container">
        <div id="left-panel" class="panel">
            <h2>AI 파일</h2>
            <div>
                <button id="upload-btn" class="btn">일러스트 파일 불러오기</button>
                <input type="file" id="file-input" accept=".ai" hidden>
                <p id="file-name">선택된 파일 없음</p>
            </div>
            <div id="ai-visualizer" class="visualizer-window">
                <span>AI 파일 시각화 영역</span>
            </div>
        </div>

        <div id="center-panel" class="panel">
            <h2>레이어 목록</h2>
            <div id="layer-list-container">
                <div id="special-layers">
                    </div>
                <hr id="layer-separator" style="display: none;">
                <div id="dynamic-layers">
                    <p>AI 파일을 업로드하세요.</p>
                </div>
            </div>
        </div>

        <div id="right-panel" class="panel">
            <h2 id="right-panel-title">정보</h2>
            <div id="right-panel-header">
                <div id="area-stats">
                    <p><strong>광고 면적 비율:</strong> <span id="ratio-value">-</span>%</p>
                    <p>버스의 광고 가능 면적: <span id="ad-possible-area-value">-</span> px²</p>
                    <p>광고 면적: <span id="ad-area-value">-</span> px²</p>
                </div>
                <div id="view-options">
                    <label><input type="checkbox" id="mask-check"> 마스크</label>
                </div>
            </div>
            <div id="layer-visualizer" class="visualizer-window">
                <span id="layer-visualizer-text">선택된 레이어 시각화 영역</span>
            </div>
            <div id="calculation-result">
                <strong>현재 선택한 레이어의 면적 비율:</strong> <span id="selected-layer-ratio">-</span>%
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 요소 가져오기 ---
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const aiVisualizerDiv = document.getElementById('ai-visualizer');

            const layerListContainer = document.getElementById('layer-list-container');
            const specialLayersDiv = document.getElementById('special-layers');
            const dynamicLayersDiv = document.getElementById('dynamic-layers');
            const layerSeparator = document.getElementById('layer-separator');

            const rightPanelTitle = document.getElementById('right-panel-title');
            const layerVisualizerDiv = document.getElementById('layer-visualizer');
            const ratioValue = document.getElementById('ratio-value');
            const adPossibleAreaValueSpan = document.getElementById('ad-possible-area-value');
            const adAreaValueSpan = document.getElementById('ad-area-value');
            const selectedLayerRatioSpan = document.getElementById('selected-layer-ratio');

            const maskCheck = document.getElementById('mask-check');

            let specialVisualsData = {}; // 특별 시각화 데이터 저장
            let dynamicLayersData = []; // 동적 레이어 데이터 저장용 배열

            // --- 이벤트 리스너 ---
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.name.endsWith('.ai')) {
                        requestCalculation(file);
                    } else {
                        alert('.ai 파일만 업로드할 수 있습니다.');
                    }
                }
            });

            layerListContainer.addEventListener('change', (event) => {
                if (event.target.name === 'layer') {
                    const selectedRadio = event.target;
                    const viewType = selectedRadio.value;

                    if (viewType.startsWith('special-')) {
                        const key = viewType.replace('special-', '');
                        const visualData = specialVisualsData?.[key];
                        if(visualData) {
                            const name = selectedRadio.dataset.name;
                            updateRightPanel(name, visualData.area, visualData.image, 'png');
                        }
                    } else {
                        const value = selectedRadio.value; // e.g., "dynamic-2"
                        const index = parseInt(value.split('-')[1]); // e.g., 2

                        if (!isNaN(index) && dynamicLayersData?.[index]) {
                            const layerData = dynamicLayersData?.[index];
                            updateRightPanel(layerData.name, layerData.area, layerData.image, 'png');
                        }
                    }
                }
            });

            maskCheck.addEventListener('change', () => {
                // 현재 선택된 레이어 정보를 다시 가져와 updateRightPanel 호출
                const selectedRadio = layerListContainer.querySelector('input:checked');
                if (selectedRadio) {
                    const viewType = selectedRadio.value;
                    if (viewType.startsWith('special-')) {
                        const key = viewType.replace('special-', '');
                        const visualData = specialVisualsData?.[key];
                        if (visualData) {
                            updateRightPanel(selectedRadio.dataset.name, visualData.area, visualData.image, 'png');
                        }
                    } else {
                        const index = parseInt(viewType.split('-')[1]);
                        if (!isNaN(index) && dynamicLayersData?.[index]) {
                            const layerData = dynamicLayersData?.[index];
                            updateRightPanel(layerData.name, layerData.area, layerData.image, 'png');
                        }
                    }
                }
            });

            // --- 함수 정의 ---

            async function requestCalculation(file) {
                const formData = new FormData();
                formData.append('aiFile', file);

                fileNameDisplay.textContent = `선택된 파일: ${file.name} (처리 중...)`;
                uploadBtn.disabled = true;
                aiVisualizerDiv.innerHTML = '<span>AI 파일 변환 중...</span>';
                dynamicLayersDiv.innerHTML = '<p>레이어 분석 중입니다...</p>';
                specialLayersDiv.innerHTML = '';
                layerSeparator.style.display = 'none';

                try {
                    const response = await fetch('http://127.0.0.1:5000/api/calculate', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || `서버 오류: ${response.status}`);

                    // 왼쪽 패널 시각화
                    if (data.visualization) {
                        aiVisualizerDiv.innerHTML = data.visualization;
                        const svgElement = aiVisualizerDiv.querySelector('svg');
                        if (svgElement) {
                            svgElement.style.width = '100%';
                            svgElement.style.height = '100%';
                        }
                    }

                    // 특별 시각화 데이터 저장 및 정적 UI 생성
                    if (data.special_visuals) {
                        specialVisualsData = data.special_visuals;
                        populateSpecialLayers();

                        const adPossibleArea = specialVisualsData?.ad_possible?.area;
                        const adArea = specialVisualsData?.ad_area?.area;

                        // 고정된 광고 면적 비율 계산 및 표시
                        let fixedRatioString = '-';
                        if (adPossibleArea && adPossibleArea > 0 && adArea) {
                            const fixedRatio = (parseInt(adArea) / adPossibleArea) * 100;
                            fixedRatioString = fixedRatio.toFixed(1);
                        }
                        ratioValue.textContent = fixedRatioString;

                        // 광고 가능 면적과 광고 면적 값 표시
                        adPossibleAreaValueSpan.textContent = adPossibleArea ? parseInt(adPossibleArea).toLocaleString() : '-';
                        adAreaValueSpan.textContent = adArea ? parseInt(adArea).toLocaleString() : '-';
                    }

                    // 동적 레이어 목록 생성
                    if (Array.isArray(data.layers)) {
                        dynamicLayersData = data.layers;
                        populateDynamicLayers(data.layers);
                    }

                    // 첫 번째 정적 레이어를 기본 선택
                    const firstRadio = specialLayersDiv.querySelector('input[type="radio"]');
                    if (firstRadio) {
                        firstRadio.checked = true;
                        firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                } catch (error) {
                    console.error("오류 발생:", error);
                    aiVisualizerDiv.innerHTML = `<span>오류: ${error.message}</span>`;
                    dynamicLayersDiv.innerHTML = '';
                    specialLayersDiv.innerHTML = '';
                } finally {
                    fileNameDisplay.textContent = `선택된 파일: ${file.name}`;
                    uploadBtn.disabled = false;
                }
            }

            function createRadioElement(id, name, text, area) {
                const label = document.createElement('label');
                label.className = 'layer-item';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'layer';
                radio.value = id;
                radio.dataset.name = text;
                radio.dataset.area = area;

                label.appendChild(radio);
                let labelText = text;
                if (area !== undefined && area > 0) {
                    labelText += ` (${area.toLocaleString()} px)`;
                }
                label.appendChild(document.createTextNode(labelText));
                return label;
            }

            function populateSpecialLayers() {
                specialLayersDiv.innerHTML = '';
                specialLayersDiv.appendChild(createRadioElement('special-all_view', '전체보기', '전체보기', specialVisualsData.all_view.area));
                specialLayersDiv.appendChild(createRadioElement('special-ad_possible', '버스의 광고 가능 면적', '버스의 광고 가능 면적', specialVisualsData.ad_possible.area));
                specialLayersDiv.appendChild(createRadioElement('special-ad_area', '광고 면적', '광고 면적', specialVisualsData.ad_area.area));
            }

            function populateDynamicLayers(layers) {
                dynamicLayersDiv.innerHTML = '';
                if (layers && layers.length > 0) {
                    layerSeparator.style.display = 'block';
                }
                layers.forEach((layer, index) => {
                    const radioElement = createRadioElement(
                        `dynamic-${index}`,
                        layer.name,
                        layer.name,
                        layer.area
                    );
                    dynamicLayersDiv.appendChild(radioElement);
                });
            }

            function updateRightPanel(layerName, pixelArea, visualData, type) {
                if (!layerName) return;

                rightPanelTitle.textContent = layerName;

                if (visualData && type === 'png') {
                    const base64Src = `data:image/png;base64,${visualData}`;
                    if (maskCheck.checked) {
                        applyMask(base64Src, (maskedImageSrc) => {
                            layerVisualizerDiv.innerHTML = `<img src="${maskedImageSrc}" alt="${layerName} 마스크 시각화" />`;
                        });
                    } else {
                        layerVisualizerDiv.innerHTML = `<img src="${base64Src}" alt="${layerName} 시각화" />`;
                    }
                } else {
                    layerVisualizerDiv.innerHTML = '<span>시각화 데이터 없음</span>';
                }

                const adPossibleArea = specialVisualsData?.ad_possible?.area;
                let dynamicRatioString = '-';

                if (adPossibleArea && adPossibleArea > 0 && pixelArea) {
                    const dynamicRatio = (parseInt(pixelArea) / adPossibleArea) * 100;
                    dynamicRatioString = dynamicRatio.toFixed(1);
                }
                selectedLayerRatioSpan.textContent = dynamicRatioString;
            }
            
            function applyMask(base64Image, callback) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i + 3] > 0) {
                            data[i] = 0;
                            data[i + 1] = 0;
                            data[i + 2] = 0;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                    
                    callback(canvas.toDataURL('image/png'));
                };
                img.src = base64Image;
            }
        });
    </script>
</body>
</html>